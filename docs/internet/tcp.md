# TCP

## TCP通信

### 三次握手
* 第一次握手：建立连接，客户端发送 SYN = 1 报文，并发送序列号 seq = x，客户端进入 SYN_SEND 状态;
* 第二次握手：服务端收到第一次握手发送的报文，发送 SYN=1 + ACK=x+1 报文，并发送序列号 seq = y，服务器进入 SYN_RECV 状态;
* 第三次握手：客户端收到第二次握手发送的报文，发送 ACK = y+1 报文，并发送序列号seq = z，客户端进入连接状态，服务端收到后也进入连接状态。

**为什么握手三次?**
防止造成服务器资源浪费。

假如客户端的某一个请求在网络中的某个节点滞留了一段时间，本来是一条作废的请求，过了一段时间后到了服务器，这时服务器会认为是一次新的请求，同意建立连接后，此时客户端已经把这条连接作废了，所以造成服务器资源浪费。

### 四次挥手
* 第一次挥手：客户端向服务端发起 FIN + ACK 报文和序列号 seq，表示客户端没有数据发送给服务端了;
* 第二次挥手：服务端向客户端发送 ACK 报文和序列号 seq，表示同意此次断开连接;
* 第三次挥手：服务端向客户端发送 FIN + ACK 报文和序列号 seq，表示服务端没有数据发送给客户端了;
* 第四次挥手：客户端向服务端发送ACK报文和序列号seq，表示同意此次断开连接，等待2MSL后断开连接。

**为什么挥手四次?**  
因为TCP支持全双工通信，前两次挥手只解决了客户端不发送数据到服务端，但是此时服务端还是可以发送数据到客户端，后两次挥手就解决服务端不发送数据到客户端。

**为什么要等待2MSL？**  
MSL：报文段的最大生存时间，指任何报文在网络上存在的最长时间，超过这个时间的报文会被丢弃。实际应用常是30秒、1分钟、2分钟。
  1. 保证TCP协议的全双工通信能被可靠关闭；  
    `如果客户端不等待直接关闭，第三次挥手发送的报文可能因为网络原因没有发送到服务端，这时服务端没有收到客户端最后发送的报文，超时后会重新向客户端发送 FIN，但是客户端已经进入关闭状态，不能相对应做出相应处理。`
  2.  保证这次连接的重复数据段从网络中消失。

---

## TCP、UDP 的区别
说明|TCP|UDP
--|:--:|:--:
可靠性|可靠| 不可靠
连接性|面向连接|无连接
报文|面向字节流|面向报文
效率|传输效率低|传输效率高
双工性|全双工|一对一、一对多、多对一、多对多
流量控制|滑动窗口|无
拥塞控制|慢开始、拥塞避免、快重传、快恢复|无
应用场景|对效率要求低、对准确性要求高|效率要求高、准确性要求低