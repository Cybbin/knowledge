<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>事件循环 (Event Loop) | 知识库</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="">
    <link rel="preload" href="/knowledge/assets/css/0.styles.bef9b11d.css" as="style"><link rel="preload" href="/knowledge/assets/js/app.dfbc139f.js" as="script"><link rel="preload" href="/knowledge/assets/js/2.08c02a28.js" as="script"><link rel="preload" href="/knowledge/assets/js/14.bad9e520.js" as="script"><link rel="prefetch" href="/knowledge/assets/js/10.5f2e78e2.js"><link rel="prefetch" href="/knowledge/assets/js/11.63754800.js"><link rel="prefetch" href="/knowledge/assets/js/12.b972a0bf.js"><link rel="prefetch" href="/knowledge/assets/js/13.2702d3f6.js"><link rel="prefetch" href="/knowledge/assets/js/15.16b13ca4.js"><link rel="prefetch" href="/knowledge/assets/js/16.7b5e6a0a.js"><link rel="prefetch" href="/knowledge/assets/js/17.096c9942.js"><link rel="prefetch" href="/knowledge/assets/js/18.dab4d708.js"><link rel="prefetch" href="/knowledge/assets/js/19.5c093edf.js"><link rel="prefetch" href="/knowledge/assets/js/20.61edfc05.js"><link rel="prefetch" href="/knowledge/assets/js/21.a7f11e97.js"><link rel="prefetch" href="/knowledge/assets/js/22.2f0ae7f0.js"><link rel="prefetch" href="/knowledge/assets/js/23.84645bbf.js"><link rel="prefetch" href="/knowledge/assets/js/24.fd487c08.js"><link rel="prefetch" href="/knowledge/assets/js/25.6feed37d.js"><link rel="prefetch" href="/knowledge/assets/js/26.6b85087e.js"><link rel="prefetch" href="/knowledge/assets/js/27.f06bf07c.js"><link rel="prefetch" href="/knowledge/assets/js/28.e267854e.js"><link rel="prefetch" href="/knowledge/assets/js/29.e67df1d2.js"><link rel="prefetch" href="/knowledge/assets/js/3.41e1f9a8.js"><link rel="prefetch" href="/knowledge/assets/js/30.76ad3738.js"><link rel="prefetch" href="/knowledge/assets/js/31.283efb85.js"><link rel="prefetch" href="/knowledge/assets/js/32.db99bac6.js"><link rel="prefetch" href="/knowledge/assets/js/33.2e0c7ea9.js"><link rel="prefetch" href="/knowledge/assets/js/34.524710f9.js"><link rel="prefetch" href="/knowledge/assets/js/35.d64551c3.js"><link rel="prefetch" href="/knowledge/assets/js/36.674c8291.js"><link rel="prefetch" href="/knowledge/assets/js/37.fb236675.js"><link rel="prefetch" href="/knowledge/assets/js/38.4347c25b.js"><link rel="prefetch" href="/knowledge/assets/js/39.9d04613a.js"><link rel="prefetch" href="/knowledge/assets/js/4.df4a3632.js"><link rel="prefetch" href="/knowledge/assets/js/40.1ba85369.js"><link rel="prefetch" href="/knowledge/assets/js/41.a3daf7be.js"><link rel="prefetch" href="/knowledge/assets/js/42.abc64d38.js"><link rel="prefetch" href="/knowledge/assets/js/43.361ec9fc.js"><link rel="prefetch" href="/knowledge/assets/js/44.3371bd4c.js"><link rel="prefetch" href="/knowledge/assets/js/45.a46fa91e.js"><link rel="prefetch" href="/knowledge/assets/js/46.79d5ff6d.js"><link rel="prefetch" href="/knowledge/assets/js/47.d23e6ec0.js"><link rel="prefetch" href="/knowledge/assets/js/48.e4acb786.js"><link rel="prefetch" href="/knowledge/assets/js/49.5bd1afa8.js"><link rel="prefetch" href="/knowledge/assets/js/5.ba29017e.js"><link rel="prefetch" href="/knowledge/assets/js/50.5cc40cff.js"><link rel="prefetch" href="/knowledge/assets/js/51.35083646.js"><link rel="prefetch" href="/knowledge/assets/js/6.5912b1c9.js"><link rel="prefetch" href="/knowledge/assets/js/7.1a448017.js"><link rel="prefetch" href="/knowledge/assets/js/8.3fe8fc9a.js"><link rel="prefetch" href="/knowledge/assets/js/9.4985830a.js">
    <link rel="stylesheet" href="/knowledge/assets/css/0.styles.bef9b11d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/knowledge/" class="home-link router-link-active"><!----> <span class="site-name">知识库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/knowledge/frontend/javascript/variable.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/knowledge/vue/start/instructor.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/knowledge/node/express/middleware.html" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/knowledge/internet/http.html" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/knowledge/data-structure/linkedlist.html" class="nav-link">
  数据结构
</a></div> <a href="https://github.com/Cybbin/knowledge" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/knowledge/frontend/javascript/variable.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/knowledge/vue/start/instructor.html" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/knowledge/node/express/middleware.html" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/knowledge/internet/http.html" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/knowledge/data-structure/linkedlist.html" class="nav-link">
  数据结构
</a></div> <a href="https://github.com/Cybbin/knowledge" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Javascript</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge/frontend/javascript/variable.html" class="sidebar-link">变量</a></li><li><a href="/knowledge/frontend/javascript/closure.html" class="sidebar-link">闭包</a></li><li><a href="/knowledge/frontend/javascript/prototype.html" class="sidebar-link">原型链和继承</a></li><li><a href="/knowledge/frontend/javascript/cross-domain.html" class="sidebar-link">跨域</a></li><li><a href="/knowledge/frontend/javascript/event-loop.html" aria-current="page" class="active sidebar-link">事件循环 (Event Loop)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge/frontend/javascript/event-loop.html#进程、线程" class="sidebar-link">进程、线程</a></li><li class="sidebar-sub-header"><a href="/knowledge/frontend/javascript/event-loop.html#宏任务、微任务" class="sidebar-link">宏任务、微任务</a></li><li class="sidebar-sub-header"><a href="/knowledge/frontend/javascript/event-loop.html#event-loop" class="sidebar-link">Event Loop</a></li><li class="sidebar-sub-header"><a href="/knowledge/frontend/javascript/event-loop.html#浏览器事件循环流程" class="sidebar-link">浏览器事件循环流程</a></li><li class="sidebar-sub-header"><a href="/knowledge/frontend/javascript/event-loop.html#node-js-事件循环" class="sidebar-link">Node.js 事件循环</a></li><li class="sidebar-sub-header"><a href="/knowledge/frontend/javascript/event-loop.html#async-await-执行顺序" class="sidebar-link">async / await 执行顺序</a></li></ul></li><li><a href="/knowledge/frontend/javascript/code.html" class="sidebar-link">手撸代码</a></li><li><a href="/knowledge/frontend/javascript/currying.html" class="sidebar-link">柯里化</a></li><li><a href="/knowledge/frontend/javascript/promise.html" class="sidebar-link">Promise</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Javascript 设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>鉴权方式</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="事件循环-event-loop"><a href="#事件循环-event-loop" class="header-anchor">#</a> 事件循环 (Event Loop)</h1> <h2 id="进程、线程"><a href="#进程、线程" class="header-anchor">#</a> 进程、线程</h2> <ul><li>计算机在调度任务时，是以进程为单位的，也是分配任务的最小单位。</li> <li>浏览器是一个多进程的（每一个标签页都是一个进程）</li> <li>每个标签页里有一个渲染进程（浏览器内核）、网络进程、绘图绘制（GPU渲染进程）等</li> <li><code>Javascript</code> 渲染进程（浏览器内核）中运行，该进程包括多个线程：
<ul><li><code>ui</code>渲染线程；</li> <li><code>javascript</code>引擎，执行<code>js</code>（<code>ui</code>和<code>js</code>是互斥的，共用一个线程）；</li> <li>事件线程（<code>click</code>、定时器、<code>ajax</code>等）</li> <li>事件触发线程（<code>Event Loop</code>，单独的调度线程，处理事件、处理定时器、处理 <code>ajax</code> 回调）</li></ul></li></ul> <h2 id="宏任务、微任务"><a href="#宏任务、微任务" class="header-anchor">#</a> 宏任务、微任务</h2> <h3 id="macro-task-宏任务"><a href="#macro-task-宏任务" class="header-anchor">#</a> <code>macro-task</code>(宏任务)</h3> <ul><li>包括整体代码 script</li> <li>setTimeout</li> <li>setInterval</li> <li>setImmediate（IE10+、Node.js）</li> <li>requestAnimationFrame（浏览器独有）</li> <li>I/O</li> <li>UI rendering（浏览器独有）</li></ul> <h3 id="micro-task-微任务"><a href="#micro-task-微任务" class="header-anchor">#</a> <code>micro-task</code>(微任务)</h3> <ul><li>Promise</li> <li>MutationObserver</li> <li>process.nextTick（Node.js独有）</li> <li><s>Object.observe</s>（废弃）</li></ul> <h2 id="event-loop"><a href="#event-loop" class="header-anchor">#</a> Event Loop</h2> <p><code>Javascript</code> 有一个主线程 <code>main thread</code> 和调用栈（执行栈）<code>call-stack</code>，所有的任务都会放到调用栈等待主线程执行。</p> <h3 id="调用栈"><a href="#调用栈" class="header-anchor">#</a> 调用栈</h3> <p>采用先进后出、后进先出的规则，当函数执行时，会被添加到栈的顶部，当该函数执行完成后，就会从栈顶移出，直到栈内被清空。</p> <h3 id="同步任务和异步任务"><a href="#同步任务和异步任务" class="header-anchor">#</a> 同步任务和异步任务</h3> <p>单线程任务被分为同步任务和异步任务，同步任务在调用栈按照顺序等待主线程以此执行，异步任务会在异步任务有了结果后，将注册的回调函数放入任务队列 <code>Task queue</code> 中等待调用栈被清空的时候，读取到调用栈内执行。</p> <img src="/knowledge/assets/event-loop/task.jpg"> <h2 id="浏览器事件循环流程"><a href="#浏览器事件循环流程" class="header-anchor">#</a> 浏览器事件循环流程</h2> <ol><li>从任务队列取出一个<strong>宏任务</strong>并执行；</li> <li>执行并清空<strong>微任务</strong>队列，如果微任务的执行中又加入了新的微任务，也会在这一步一起执行;</li> <li>进入更新渲染阶段，判断是否需要渲染，不一定每一轮 <code>Event Loop</code> 都会执行渲染，取决于屏幕刷新率、页面性能、页面是否在后台运行来共同决定。
<ul><li>浏览器会尽可能的保持帧率稳定，如页面性能 60fps （每16.6ms渲染一次）。</li> <li>满足下面条件，会跳过渲染：
<ol><li>浏览器判定更新渲染不会带来视觉上的变化。</li> <li>帧动画回调为空（通过 <code>requestAnimationFrame</code> ）来请求帧动画。</li></ol></li></ul></li> <li>如果第3步决定本轮 <code>Event Loop</code>需要渲染，继续往下运行，否则跳转第一步；</li> <li>如果窗口大小发生了变化，执行监听的 <code>resize</code> 方法；</li> <li>如果页面发生了滚动，执行监听的 <code>scroll</code> 方法；</li> <li>执行帧动画回调，也就是 <code>requestAnimationFrame</code> 的回调；</li> <li>执行 <code>IntersectionObserver</code> 的回调；</li> <li>重新渲染绘制用户界面。</li></ol> <img src="/knowledge/assets/event-loop/eventloop.jpg"> <h2 id="node-js-事件循环"><a href="#node-js-事件循环" class="header-anchor">#</a> Node.js 事件循环</h2> <blockquote><p><a href="https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// 此阶段执行已经放进队列的 setTimeout、setInterval 回调函数</span>
   ┌───────────────────────────┐
┌─<span class="token operator">&gt;</span>│           timers          │
│  └─────────────┬─────────────┘   
│ <span class="token comment">// 执行延迟到下一个循环迭代的 I/O 回调</span>
│  ┌─────────────┴─────────────┐
│  │     pending callbacks     │
│  └─────────────┬─────────────┘        
│ <span class="token comment">// 供系统内部使用</span>
│  ┌─────────────┴─────────────┐
│  │       idle<span class="token punctuation">,</span> prepare       │
│  └─────────────┬─────────────┘
│                │             │               
│ <span class="token comment">// 轮询，检测新的I/O 事件，执行与I/O相关的回调，如 fs.readFile</span>
│                │             │      ┌───────────────┐
│  ┌─────────────┴─────────────┐      │   incoming<span class="token operator">:</span>   │
│  │           poll            │<span class="token operator">&lt;</span>─────┤  connections<span class="token punctuation">,</span> │
│  └─────────────┬─────────────┘      │   data<span class="token punctuation">,</span> etc<span class="token punctuation">.</span>  │
│                │             │      └───────────────┘
│ <span class="token comment">// 执行 setImmediate 回调函数</span>
│  ┌─────────────┴─────────────┐
│  │           check           │
│  └─────────────┬─────────────┘
<span class="token operator">|</span>  <span class="token comment">// 执行关闭的回调函数 如 socket.on('close', ...)</span>
│  ┌─────────────┴─────────────┐
└──┤      close callbacks      │
   └───────────────────────────┘
</code></pre></div><p>三个重点阶段：<code>timers</code>、<code>poll</code>、<code>check</code></p> <h3 id="timers"><a href="#timers" class="header-anchor">#</a> timers</h3> <p>timers 阶段会执行 <code>setTimeout</code> 和 <code>setInterval</code> 回调，由 <code>poll</code> 阶段控制。定时器指定的事件不是准确事件，只能是尽快执行。</p> <h3 id="poll"><a href="#poll" class="header-anchor">#</a> poll</h3> <p>poll 阶段执行顺序：</p> <ol><li>如果存在定时器，且定时器时间到了，<code>event loop</code> 回到 <code>timer</code> 阶段；</li> <li>如果没有定时器：</li></ol> <ul><li>如果 <code>poll</code> 队列不为空，会遍历回调队列同步执行，知道队列为空或达到系统限制；</li> <li>如果 <code>poll</code> 队列为空：
<ul><li>如果有 <code>setImmediate</code> 回调需要执行，<code>poll</code> 阶段会进入 <code>check</code> 阶段执行 <code>setImmediate</code> 的回调；</li> <li>如果没有 <code>setImmediate</code> 回调需要执行，会等待回调被加入到当前队列中并执行，超出一定时间会自动进入 <code>check</code> 阶段。</li></ul></li></ul> <h3 id="check"><a href="#check" class="header-anchor">#</a> check</h3> <p><code>check</code> 阶段执行 <code>setImmediate</code> 的回调。</p> <h3 id="process-nexttick"><a href="#process-nexttick" class="header-anchor">#</a> process.nextTick</h3> <p><code>process.nextTick</code> 有一个独立于 <code>evevt loop</code> 的任务队列</p> <p>在每一个 <code>event loop</code> 阶段完成后会检查 <code>nextTick</code> 队列，如果里面有任务，会清空该队列。</p> <h3 id="node-版本差异"><a href="#node-版本差异" class="header-anchor">#</a> Node 版本差异</h3> <p><code>Node 11</code> 版本前后差异：</p> <ul><li><code>Node 11</code>之前：每执行一个阶段才回去清空微任务；</li> <li><code>Node 11</code>之后：每执行一个宏任务（<code>setTimeout、setInterval、serImmediate</code>）后就会清空微任务。</li></ul> <h2 id="async-await-执行顺序"><a href="#async-await-执行顺序" class="header-anchor">#</a> async / await 执行顺序</h2> <p><code>await</code> 后面的函数执行完毕时，<code>await</code>会产生一个微任务（<code>Promise.then</code>）。注意这个微任务的产生时机：</p> <ul><li>执行完<code>await</code>后面函数之后，直接跳出 <code>async</code> 函数，执行其他代码；</li> <li>其他代码执行完后，再回到 <code>async</code> 函数去执行剩下的代码，在此时产生微任务。</li></ul> <blockquote><p><a href="https://www.zhihu.com/question/268007969" target="_blank" rel="noopener noreferrer">async/await 在chrome 环境和 node 环境的 执行结果不一致，求解？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">7/5/2020, 10:56:07 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/knowledge/frontend/javascript/cross-domain.html" class="prev">
        跨域
      </a></span> <span class="next"><a href="/knowledge/frontend/javascript/code.html">
        手撸代码
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/knowledge/assets/js/app.dfbc139f.js" defer></script><script src="/knowledge/assets/js/2.08c02a28.js" defer></script><script src="/knowledge/assets/js/14.bad9e520.js" defer></script>
  </body>
</html>
